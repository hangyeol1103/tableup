<!DOCTYPE html>
<html 
lang="ko" 
xmlns:th="http://www.thymeleaf.org"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
layout:decorate="~{layout/manager_layout.html}"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security" >
<head>
	<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.css" rel="stylesheet"> -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>
	<title>í…Œì´ë¸”ì—… - ë§¤ë‹ˆì €í˜ì´ì§€</title>
	<style>
  
  </style>
</head>
<body>
	<main layout:fragment="content">
    <div class="container">
      <h1>ì˜ˆì•½ í˜„í™©</h1>
      <div id='calendar'></div>
    </div>
    <div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="dateModalLabel">
              <p><strong id="selectedDate">-</strong>ì˜ˆì•½ í˜„í™©</p>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
          </div>
          <div class="modal-body" id="modalBody">
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
        </div>
      </div>
    </div>
		<script>
      /***************************************
      * ë¬¸êµ¬ ë³€ê²½ì‹œ ì—¬ê¸°ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.
      ****************************************/
      //ì˜ˆì•½ ìƒíƒœ ê´€ë ¨ ë¬¸êµ¬
      const readyState = "ì˜ˆì•½ ëŒ€ê¸°", cancelState = "ì˜ˆì•½ ì·¨ì†Œ", confirmState = "ì˜ˆì•½ í™•ì •";
      //0ë²ˆì§€ : ì·¨ì†Œ, 1ë²ˆì§€ : ëŒ€ê¸°, 2ë²ˆì§€ : í™•ì •. ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
      const colorList = ['red', 'green', 'skyblue']; //convertReservationToObject í•¨ìˆ˜ì—ì„œ ì‚¬ìš©

      /***************************************************
       * í™”ë©´ êµ¬ì„± ì‹œ ì—¬ê¸°ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”
      ****************************************************/
      //ë‹¬ë ¥ì—ì„œ ë‚ ì§œ í´ë¦­ ì‹œ ë“±ë¡ëœ ì˜ˆì•½ ëª©ë¡ì„ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜. 
      function viewModal(info){
        const selectedDateEl = document.getElementById('selectedDate');
        selectedDateEl.textContent = info.dateStr;
        const dateModal = new bootstrap.Modal(document.getElementById('dateModal'));
        dateModal.show();
        let list = getReservateionList(info.dateStr);
        let str = '';
        list.forEach(res=>{
          let obj = convertReservationToObject(res);
          str += 
          `
            <div>
              <div>${obj.time}</div>
              <div>${obj.user}(${obj.person}ëª…)</div>
              <div>${obj.state}</div>
            </div>
            <div>
              ${obj.res_state == 0 ? '<button type="button" class="btn btn-outline-success">'+confirmState+'</button>' : ''}
              ${obj.res_state >= 0 ? '<button type="button" class="btn btn-outline-danger">'+cancelState+'</button>' : ''}
            </div>
          `
        })
        str = str.length == 0 ? "ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤." : str;
        $("#modalBody").html(str);
      }

      /***************************************
       * ë³€í™˜ í•¨ìˆ˜ë“¤ : ì½”ë“œì˜ ì¬ì‚¬ìš©ì„ ìœ„í•´ ë§Œë“¬
      ****************************************/
      /***************************************
       * í•¨ìˆ˜ : num ì•ì— 0ìœ¼ë¡œ ì±„ì›Œ ë°˜í™˜. ê¸€ì ê¸¸ì´ë¥¼ size ê¸°ì¤€ìœ¼ë¡œ
       * ì˜ˆì‹œ : 5 => 05ë¡œ ë³€í™˜
      ****************************************/
      function fillZero(num, size) {
        return num.toString().padStart(size, '0');
      }
      /***************************************
       * í•¨ìˆ˜ : Dateê°ì²´ë¥¼ yyyy-MM ë¬¸ìì—´ë¡œ ë³€í™˜
      ****************************************/
      function convertDateToString(date){
        const year = date.getFullYear();
        const month = fillZero(date.getMonth() + 1, 2); 
        return `${year}-${month}`;
      }
      /***************************************
       * í•¨ìˆ˜ : [yyyy, M, d] ë…„, ì›”, ì¼ì´ ë“¤ì–´ ìˆëŠ” ë°°ì—´ì„ yyyy-MM-dd ë¬¸ìì—´ë¡œ ë³€í™˜
       * ì˜ˆì‹œ : [2025,5,15] => 2025-05-15
      ****************************************/
      function convertArrayToDateString(arr){
        const year = arr[0];
        const month = fillZero(arr[1],2); 
        const date = fillZero(arr[2],2); ; 
        return `${year}-${month}-${date}`;
      } 
      /***************************************
       * í•¨ìˆ˜ : ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜ˆì•½ ëª©ë¡ì„ ê°€ì ¸ì™€ì„œ ë°°ì—´ë¡œ ë°˜í™˜
      ****************************************/
      function getReservateionList(date){
        //dateê°€ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë…„ ì›” ì¼
        if(!date){
          date = convertDateToString(new Date());
        }
        
        let res = [];
        $.ajax({
          async : false,
          url : '/manager/reservation/date',
          method : 'post',
          data : {date },
          success : data =>{
            res = data;
          }, error : e => console.log(e)
        })
        return res;
      }

      /***************************************
       * í•¨ìˆ˜ : ì˜ˆì•½ ë‚´ì—­ë¦¬ìŠ¤íŠ¸ë¥¼ ì¼ˆë¦°ë”ì— ì¶”ê°€í•˜ê¸° ìœ„í•´ eventë“¤ë¡œ ë³€í™˜
      ****************************************/
      function getEvents(date){

        let list = getReservateionList(date);

        return list.map(res=>{
          let obj = convertReservationToObject(res)
          return {
            start: obj.date,
            end: obj.date,
            title : obj.title,
            backgroundColor: obj.color,
            borderColor: obj.color
          }
        })
      }
      /***************************************
       * í•¨ìˆ˜ : ì˜ˆì•½ ë‚´ì—­ì„ ê°ì²´ë¡œ ë³€í™˜
      ****************************************/
      function convertReservationToObject(res){
        
        let date = convertArrayToDateString(res.res_time);
        let time = res.res_time.slice(3,5).join(":");
        let user = res.user.us_id;
        let res_state = res.res_state;
        let person = res.res_person;
        let state = res_state == 0 ? readyState : res_state == 1 ? confirmState : cancelState;
        let title = `${time} ${user}(${person}ëª…) ${state}`;
        let color = colorList[res_state+1];
        return { date,time,title,color,state,user, res_state, person}
      }
  
      
      /***************************************
       * ìº˜ë¦°ë” ë¶€ë¶„
      ****************************************/
      //ìº˜ë¦°ë”ë¥¼ ê·¸ë ¤ì¤„ ìš”ì†Œ
			var calendarEl = document.getElementById('calendar'); 
      //ìº˜ë¦°ë” ìƒì„±
			var calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'ko',
				initialView: 'dayGridMonth',
        //ìº˜ë¦°ë” í—¤ë”
        headerToolbar: {
          left: 'prev',
          center: 'title',
          right: 'next'
        },
        events: function(fetchInfo, success, fail){
          //ë³´ì´ëŠ” ë‹¬ë ¤ì˜ ë…„-ì›”ì„ ì¶”ì¶œí•˜ê¸° ìœ„í•´ ì¤‘ì•™ ë‚ ì§œë¥¼ ê³„ì‚°
          const start = fetchInfo.start.getTime();//ë³´ì´ëŠ” ë‹¬ë ¥ ì‹œì‘ì¼
          const end = fetchInfo.end.getTime();//ë³´ì´ëŠ” ë‹¬ë ¥ ë§ˆì§€ë§‰ì¼
          const centerTime = new Date((start + end) / 2); // ì¤‘ì•™ ë‚ ì§œ

          const date = convertDateToString(centerTime);//ë‚ ì§œë¥¼ yyyy-MMë¡œ ë³€í™˜
          let events = getEvents(date);//í˜„ì¬ ë‹¬ë ¤ì„ ê¸°ì¤€ìœ¼ë¡œ ë“±ë¡ëœ ì´ë²¤íŠ¸ë“¤ì„ ê°€ì ¸ì˜´
          success(events);//ì´ë²¤íŠ¸ë“¤ì„ í™”ë©´ì— ì¶œë ¥
        },
        dayMaxEventRows: true, //ìµœëŒ€ í¬ê¸° ì„¤ì •
        dateClick: function(info) { //ë‚ ì§œ í´ë¦­ ì‹œ
          viewModal(info)
        },
        eventClick: function(info) {
          const clickedDate = info.event.startStr;
          calendar.getOption('dateClick')({ dateStr: clickedDate });
        },
        titleFormat: { year: 'numeric', month: 'long' }, // ğŸ‘ˆ YYYY-MM í˜•ì‹
			});
			calendar.render(); //ìº˜ë¦°ë” ë Œë”ë§(í™”ë©´ì— ì¶œë ¥)
      
		</script>
	</main>
</body>
</html>
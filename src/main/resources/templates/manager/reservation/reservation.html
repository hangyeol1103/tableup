<!DOCTYPE html>
<html 
lang="ko" 
xmlns:th="http://www.thymeleaf.org"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
layout:decorate="~{layout/manager_layout.html}"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security" >
<head>
	<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.css" rel="stylesheet"> -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>
	<title>í…Œì´ë¸”ì—… - ë§¤ë‹ˆì €í˜ì´ì§€</title>
	<style>
    .modal-body-scrollable {
      max-height: 400px; /* ì•½ 2.5ê°œ ì¹´ë“œ ì •ë„ ë†’ì´ */
      overflow-y: auto;
    }
  </style>
</head>
<body>
	<main layout:fragment="content">
    <div class="container">
      <h1>ì˜ˆì•½ í˜„í™©</h1>
      <div id='calendar'></div>
    </div>
    <!-- ë‚ ì§œ í´ë¦­ ì‹œ ëœ¨ëŠ” ëª¨ë‹¬ ì°½ -->
    <div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="dateModalLabel">
              <p><strong id="selectedDate">-</strong>ì˜ˆì•½ í˜„í™©</p>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
          </div>
          <div class="modal-body modal-body-scrollable" id="modalBody">
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
        </div>
      </div>
    </div>
    <a th:href="@{/manager/restime/restimepage}" class="btn btn-outline-secondary col-12 mb-3">ì˜ˆì•½ ê´€ë¦¬ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
		<script th:inline="javascript">
      const dateModal = new bootstrap.Modal(document.getElementById('dateModal'));
      const resTimeList = /*[[${resTimeList}]]*/[];
      console.log("resTimeList : ", resTimeList);
      /***************************************
      * ë¬¸êµ¬ ë³€ê²½ì‹œ ì—¬ê¸°ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.
      ****************************************/
      //ì˜ˆì•½ ìƒíƒœ ê´€ë ¨ ë¬¸êµ¬
      const readyState = "ì˜ˆì•½ ëŒ€ê¸°", cancelState = "ì˜ˆì•½ ì·¨ì†Œ", confirmState = "ì˜ˆì•½ í™•ì •";
      //0ë²ˆì§€ : ì·¨ì†Œ, 1ë²ˆì§€ : ëŒ€ê¸°, 2ë²ˆì§€ : í™•ì •. ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
      const colorList = ['red', 'green', 'skyblue']; //convertReservationToObject í•¨ìˆ˜ì—ì„œ ì‚¬ìš©

      /***************************************************
       * í™”ë©´ êµ¬ì„± ì‹œ ì—¬ê¸°ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”
      ****************************************************/
      //ë‹¬ë ¥ì—ì„œ ë‚ ì§œ í´ë¦­ ì‹œ ë“±ë¡ëœ ì˜ˆì•½ ëª©ë¡ì„ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜. 
      function viewModal(info){
        const selectedDateEl = document.getElementById('selectedDate');
        selectedDateEl.textContent = info.dateStr;
        
        dateModal.show();
        let list = getReservateionList(info.dateStr);
        let str = '';
        list.forEach(res=>{
          let obj = convertReservationToObject(res);
          str += `
             <div class="card mb-3 shadow-sm reservation-card" data-target="memo-${obj.res_num}" style="cursor:pointer; border-left: 4px solid ${obj.res_state == 0 ? 'green' : obj.res_state == 1 ? 'skyblue' : 'red'};">
              <div class="card-body">
                <h5 class="card-title mb-2">
                  <i class="bi bi-clock"></i> ${obj.time}
                  <span class="badge bg-light text-dark ms-2">ë‚¨ì€ ì¢Œì„: ${obj.remainSeat}</span>
                </h5>
                <p class="mb-1"><strong>ì˜ˆì•½ì:</strong> ${obj.user}</p>
                <p class="mb-1"><strong>ì¸ì› ìˆ˜:</strong> ${obj.person}ëª…</p>
                <p class="mb-2"><strong>ìƒíƒœ:</strong> 
                  <span style="color: ${obj.res_state == 0 ? 'green' : obj.res_state == 1 ? 'skyblue' : 'red'}">${obj.state}</span>
                </p>

                <div class="collapse mt-2" id="memo-${obj.res_num}">
                  <div class="alert alert-secondary mb-2 py-2 px-3">
                    <strong>ìš”ì²­ì‚¬í•­:</strong> ${obj.request || 'ì—†ìŒ'}
                  </div>
                </div>

                <div class="d-flex gap-2">
                  ${obj.res_state == 0 
                    ? '<button type="button" class="btn btn-sm btn-outline-info btn-reservation"  data-target="'+obj.res_num+'" data-state="1" data-date="'+obj.date+'">'+confirmState+'</button>' 
                    : ''}
                  ${obj.res_state >= 0 
                    ? '<button type="button" class="btn btn-sm btn-outline-danger btn-reservation" data-target="'+obj.res_num+'" data-state="-1" data-date="'+obj.date+'">'+cancelState+'</button>' 
                    : ''}
                </div>
              </div>
            </div>
          `;
        })
        str = str.length == 0 ? "ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤." : str;
        $("#modalBody").html(str);
      }

      /***************************************
       * ë³€í™˜ í•¨ìˆ˜ë“¤ : ì½”ë“œì˜ ì¬ì‚¬ìš©ì„ ìœ„í•´ ë§Œë“¬
      ****************************************/
      /***************************************
       * í•¨ìˆ˜ : num ì•ì— 0ìœ¼ë¡œ ì±„ì›Œ ë°˜í™˜. ê¸€ì ê¸¸ì´ë¥¼ size ê¸°ì¤€ìœ¼ë¡œ
       * ì˜ˆì‹œ : 5 => 05ë¡œ ë³€í™˜
      ****************************************/
      function fillZero(num, size) {
        return num.toString().padStart(size, '0');
      }
      /***************************************
       * í•¨ìˆ˜ : Dateê°ì²´ë¥¼ yyyy-MM ë¬¸ìì—´ë¡œ ë³€í™˜
      ****************************************/
      function convertDateToString(date){
        const year = date.getFullYear();
        const month = fillZero(date.getMonth() + 1, 2); 
        return `${year}-${month}`;
      }
      /***************************************
       * í•¨ìˆ˜ : [yyyy, M, d] ë…„, ì›”, ì¼ì´ ë“¤ì–´ ìˆëŠ” ë°°ì—´ì„ yyyy-MM-dd ë¬¸ìì—´ë¡œ ë³€í™˜
       * ì˜ˆì‹œ : [2025,5,15] => 2025-05-15
      ****************************************/
      function convertArrayToDateString(arr){
        const year = arr[0];
        const month = fillZero(arr[1],2); 
        const date = fillZero(arr[2],2); ; 
        return `${year}-${month}-${date}`;
      } 
      /***************************************
       * í•¨ìˆ˜ : ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜ˆì•½ ëª©ë¡ì„ ê°€ì ¸ì™€ì„œ ë°°ì—´ë¡œ ë°˜í™˜
      ****************************************/
      function getReservateionList(date){
        //dateê°€ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë…„ ì›” ì¼
        if(!date){
          date = convertDateToString(new Date());
        }
        
        let res = [];
        $.ajax({
          async : false,
          url : '/manager/reservation/date',
          method : 'post',
          data : {date },
          success : data =>{
            res = data;
          }, error : e => console.log(e)
        })
        return res;
      }

      /***************************************
       * í•¨ìˆ˜ : ì˜ˆì•½ ë‚´ì—­ë¦¬ìŠ¤íŠ¸ë¥¼ ì¼ˆë¦°ë”ì— ì¶”ê°€í•˜ê¸° ìœ„í•´ eventë“¤ë¡œ ë³€í™˜
      ****************************************/
      function getEvents(date){

        let list = getReservateionList(date);

        return list.map(res=>{
          let obj = convertReservationToObject(res)
          return {
            start: obj.date,
            end: obj.date,
            title : obj.title,
            backgroundColor: obj.color,
            borderColor: obj.color
          }
        })
      }
      /***************************************
       * í•¨ìˆ˜ : ì˜ˆì•½ ë‚´ì—­ì„ ê°ì²´ë¡œ ë³€í™˜
      ****************************************/
      function convertReservationToObject(res){
        
        let date = convertArrayToDateString(res.res_time);
        let hour = res.res_time.slice(3,4);
        let minute = res.res_time.slice(4,5);
        let time = fillZero(hour, 2) + ":" + fillZero(minute,2);
        let user = res.user.us_id;
        let res_state = res.res_state;
        let person = res.res_person;
        let state = res_state == 0 ? readyState : res_state == 1 ? confirmState : cancelState;
        let title = `${time} ${user}(${person}ëª…) ${state}`;
        let color = colorList[res_state+1];
        let request = res.res_request || '';
        let res_num = res.res_num;

        //ì¢Œì„ ì •ë³´ ì²˜ë¦¬
        const fullDateStr = `${date}T${time}:00`; // ex. 2025-06-09 12:00:00
        const timeInfo = resTimeList.find(rt => rt.bh_start === fullDateStr);

        let remainSeat = "ì •ë³´ ì—†ìŒ";
        if (timeInfo) {
          remainSeat = timeInfo.bh_seat_max - timeInfo.bh_seat_current;
        }

        return { date,time,title,color,state,user, res_state, person, res_num, date, remainSeat, request}
      }
  
      
      /***************************************
       * ìº˜ë¦°ë” ë¶€ë¶„
      ****************************************/
      //ìº˜ë¦°ë”ë¥¼ ê·¸ë ¤ì¤„ ìš”ì†Œ
			var calendarEl = document.getElementById('calendar'); 
      //ìº˜ë¦°ë” ìƒì„±
			var calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'ko',
				initialView: 'dayGridMonth',
        //ìº˜ë¦°ë” í—¤ë”
        headerToolbar: {
          left: 'prev',
          center: 'title',
          right: 'next'
        },
        events: function(fetchInfo, success, fail){
          //ë³´ì´ëŠ” ë‹¬ë ¤ì˜ ë…„-ì›”ì„ ì¶”ì¶œí•˜ê¸° ìœ„í•´ ì¤‘ì•™ ë‚ ì§œë¥¼ ê³„ì‚°
          const start = fetchInfo.start.getTime();//ë³´ì´ëŠ” ë‹¬ë ¥ ì‹œì‘ì¼
          const end = fetchInfo.end.getTime();//ë³´ì´ëŠ” ë‹¬ë ¥ ë§ˆì§€ë§‰ì¼
          const centerTime = new Date((start + end) / 2); // ì¤‘ì•™ ë‚ ì§œ

          const date = convertDateToString(centerTime);//ë‚ ì§œë¥¼ yyyy-MMë¡œ ë³€í™˜
          let events = getEvents(date);//í˜„ì¬ ë‹¬ë ¤ì„ ê¸°ì¤€ìœ¼ë¡œ ë“±ë¡ëœ ì´ë²¤íŠ¸ë“¤ì„ ê°€ì ¸ì˜´
          success(events);//ì´ë²¤íŠ¸ë“¤ì„ í™”ë©´ì— ì¶œë ¥
        },
        dayMaxEventRows: true, //ìµœëŒ€ í¬ê¸° ì„¤ì •
        dateClick: function(info) { //ë‚ ì§œ í´ë¦­ ì‹œ
          viewModal(info)
        },
        eventClick: function(info) {
          const clickedDate = info.event.startStr;
          calendar.getOption('dateClick')({ dateStr: clickedDate });
        },
        titleFormat: { year: 'numeric', month: 'long' }, // ğŸ‘ˆ YYYY-MM í˜•ì‹
			});
			calendar.render(); //ìº˜ë¦°ë” ë Œë”ë§(í™”ë©´ì— ì¶œë ¥)
      
      /***************************************
       * ì´ë²¤íŠ¸ : ì˜ˆì•½ í™•ì •/ì·¨ì†Œ ë²„íŠ¼ í´ë¦­
      ****************************************/
      $(document).on('click', '.btn-reservation', function(){
        console.log("ë²„íŠ¼ í´ë¦­ë¨");
        let res_num = $(this).data("target");
        let res_state = $(this).data("state");
        let date = $(this).data("date");

        console.log("ë³´ë‚¼ ê°’ : ", res_num, res_state)
        $.ajax({
          url : "/manager/reservation/state",
          method : "post",
          data : JSON.stringify({res_num , res_state}),
          contentType : "application/json; charset=utf-8",
          dataType : "json",
          success : data=>{
            let res = data.res;
            let error = data.error;
            if(error){
              alert(error);
              return;
            }
            if(res){
              alert(res_state == 1 ? "ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
              
              dateModal.hide();
              calendar.refetchEvents();//ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
              setTimeout(() => {
                calendarDateClick(date);
              },400)
              location.reload();
            }
          }
        })
      })
      /**
       * í•¨ìˆ˜ : ìº˜ë¦°ë”ì—ì„œ ì§€ì • ë‚ ì§œ(date)ë¥¼ ì£¼ë©´ jsì—ì„œ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜
      */
      function calendarDateClick(date){
        // dateClick ì½œë°± ìˆ˜ë™ ì‹¤í–‰
        const dateClickHandler = calendar.getOption('dateClick');
        if (typeof dateClickHandler === 'function') {
          dateClickHandler({
            date: new Date(date),
            dateStr: date,
            view: calendar.view
          });
        }
      }

      // ì˜ˆì•½ í˜„í™© ì •ë³´ ì¹´ë“œ í´ë¦­ì‹œ ìš”êµ¬ì‚¬í•­ ì¶œë ¥ë˜ëŠ” í† ê¸€
      $(document).on('click', '.reservation-card', function (e) {
        // ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ì´ë²¤íŠ¸ ë¬´ì‹œ
        if ($(e.target).closest('.btn-reservation').length > 0) return;

        const targetId = $(this).data('target');
        $('#' + targetId).collapse('toggle');
      });

		</script>
	</main>
</body>
</html>
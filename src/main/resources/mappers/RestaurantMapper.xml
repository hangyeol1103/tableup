<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.kh.tableup.dao.RestaurantDAO">

  <!-- ReviewScoreVO + ReviewVO -->
	<resultMap id="ReviewMap" type="ReviewVO">
		<!-- ReviewVO -->
		<id property="rev_num" column="rev_num" />
		<result property="rev_us_num" column="rev_us_num" />
		<result property="rev_rt_num" column="rev_rt_num" />
		<result property="rev_content" column="rev_content" />
		<result property="rev_created" column="rev_created" />
		<result property="rev_updated" column="rev_updated" />
		<result property="rev_state" column="rev_state" />
		<result property="rev_visit" column="rev_visit" />
		<result property="rev_visitor" column="rev_visitor" />
		
		<!-- 유저와 식당 이름 -->
		<result property="us_name" column="us_name" />
		<result property="rt_name" column="rt_name" />

		<!-- ReviewScoreVO 리스트 -->
		<collection property="scoreList" ofType="ReviewScoreVO">
			<id property="rs_num" column="rs_num" />
			<result property="rs_rev_num" column="rs_rev_num" />
			<result property="rs_st_num" column="rs_st_num" />
			<result property="rs_score" column="rs_score" />
			<result property="st_num" column="st_num" />
			<result property="st_category" column="st_category" />
      <result property="rt_num" column="rt_num"/>
		</collection>

    <collection property="fileList" ofType="FileVO">
      <id property="file_num" column="file_num"/>
      <result property="file_path" column="file_path"/>
      <result property="file_name" column="file_name"/>
      <result property="file_type" column="file_type"/>
      <result property="file_foreign" column="file_foreign"/>
      <result property="file_tag" column="file_tag"/>
      <result property="file_res_num" column="file_res_num"/>
    </collection>
	</resultMap>

  <!-- 특정 식당 리뷰 + 점수 -->
	<select id="selectReviewListbyNum" resultMap="ReviewMap">
		SELECT
			review.*,
			user.us_name,
			restaurant.rt_name,
			reviewscore.*,
			scoretype.st_num, scoretype.st_category
		FROM review
		LEFT JOIN user ON review.rev_us_num = user.us_num
		LEFT JOIN restaurant ON review.rev_rt_num = restaurant.rt_num
		LEFT JOIN reviewscore ON review.rev_num = reviewscore.rs_rev_num
		LEFT JOIN scoretype ON reviewscore.rs_st_num = scoretype.st_num
    LEFT JOIN (select * from file where file_type = "REVIEW") f ON rev_num = file_res_num 
		WHERE review.rev_rt_num = #{rt_num}
		ORDER BY review.rev_num ASC, reviewscore.rs_num ASC
	</select>

  <select id="selectRestaurantByNum" parameterType="int" resultType="kr.kh.tableup.model.vo.RestaurantVO">
    SELECT * FROM restaurant WHERE rt_num = #{rt_num}
  </select>

  <select id="selectRestaurantDetailList" resultType="RestaurantDetailVO">
    select * from restaurantdetail where rd_rt_num = #{rt_num}
  </select>

</mapper>
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}">
<head>
  <meta charset="UTF-8">
  <title>식당 목록</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<main layout:fragment="content" class="container mt-5">
  <h2 class="">식당 목록</h2>

  <!-- 전체 레이아웃 -->
  <div class="row">

    <!-- 좌측 -->
    <aside class="col-md-3">

      <!-- 지역/음식 필터 박스 -->
      <form id="filterForm">
        <div class="card mb-4">
          <div class="card-header fw-bold">기본 필터</div>
          <div class="card-body">
            <!-- 지역 선택 -->
            <div class="mb-3">
              <label class="form-label">지역</label>
              <select class="form-select" id="regionSelect" onchange="loadList(true)">
                <option value="0">전체</option>
                <option th:each="region : ${regionList}"
                        th:value="${region.dreg_num}"
                        th:text="${region.reg_main + ' : ' + region.dreg_sub}"
                        th:selected="${region.dreg_num == dreg_num}"></option>
              </select>
            </div>
            <!-- 음식 종류 선택 -->
            <div>
              <label class="form-label">음식 종류</label>
              <select class="form-select" id="foodSelect" onchange="loadList(true)">
                <option value="0">전체</option>
                <option th:each="food : ${foodList}"
                        th:value="${food.dfc_num}"
                        th:text="${food.fc_main + ' : ' + food.dfc_sub}"
                        th:selected="${food.dfc_num == dfc_num}"></option>
              </select>
            </div>
          </div>
        </div>
      </form>

      <!-- 상세 조건 필터 박스 -->
      <form id="detailsearch-form">
        <div class="card mb-4">
          <div class="card-header fw-bold">상세 조건</div>
          <div class="card-body">

            <!-- 태그 필터 -->
            <div th:each="entry : ${tagList}" class="mb-3">
              <div class="fw-bold mb-1" th:text="${entry.key}">태그 대분류</div>
              <div class="form-check" th:each="tag : ${entry.value}">
                <input class="form-check-input tag-check" type="checkbox"
                      th:id="'tag-' + ${tag.tag_num}" th:value="${tag.tag_num}">
                <label class="form-check-label"
                      th:for="'tag-' + ${tag.tag_num}"
                      th:text="${tag.tag_name}"></label>
              </div>
            </div>

            <!-- 편의시설 -->
            <div class="fw-bold mt-3 mb-2">편의시설</div>
            <div class="form-check mb-1" th:each="fac : ${facilityList}">
              <input class="form-check-input facility-check" type="checkbox"
                    th:id="'fac-' + ${fac.fa_num}" th:value="${fac.fa_num}">
              <label class="form-check-label" th:for="'fac-' + ${fac.fa_num}"
                    th:text="${fac.fa_name}"></label>
            </div>

          </div>
          <div class="card-footer text-end">
            <button type="button" class="btn btn-success w-100" onclick="applyDetailedFilter()">적용</button>
          </div>
        </div>
      </form>
    </aside>

    <!-- 우측 -->
    <section class="col-md-9">
      <!-- 정렬 선택 -->
      <div class="d-flex justify-content-end mb-3">
        <select class="form-control col-3 sel-type w-auto">
          <option value="po_num desc">별점순</option>
          <option value="po_up desc, po_num desc">추천순</option>
          <option value="po_view desc, po_num desc">조회순</option>
        </select>
      </div>

      <!-- 리스트 출력 -->
      <div id="list-container" class="pl-container">
        <!-- sub.html -->
      </div>
    </section>
  </div>

  <!-- 스크립트 -->
  <script type="text/javascript">
    let cri = {
      rt_dfc_num : 0,
      rt_dreg_num : 0,
      page : 1,
      orderBy : "rt_num desc",
      tagList: [],
      facilityList: []
    }

    // 더보기 클릭 이벤트
    $(document).on("click", ".btn-more", function(e){
      $(this).remove();
      cri.page += 1;
      loadList(false); // 페이지 유지
    });

    // 정렬 방식 선택
    $(document).on("change", ".sel-type", function () {
      console.log("필터 검색 조건:", cri);
      loadList(true); 
    });

    // 상세 조건 필터 적용
    function applyDetailedFilter() {
      cri.tagList = $(".tag-check:checked").map(function () {
        return $(this).val();
      }).get();

      cri.facilityList = $(".facility-check:checked").map(function () {
        return $(this).val();
      }).get();

      loadList(true);
    }

    // 목록 불러오기
    function loadList(resetPage = false) {
      cri.rt_dfc_num = $('#foodSelect').val();
      cri.rt_dreg_num = $('#regionSelect').val();
      cri.orderBy = $('.sel-type').val();

      if (resetPage) cri.page = 1;

      $.ajax({
        async : true,
        url : "/user/list/sub",
        type : 'post',
        data : JSON.stringify(cri), 
        contentType: "application/json; charset=utf-8",
        success: function (data) {
          if (resetPage) {
            $(".pl-container").html(data);
          } else {
            $(".pl-container").append(data); 
          }
        },
        error: function () {
          $(".pl-container").html('<div class="text-danger">불러오는 데 실패했습니다.</div>');
        }
      });
    }

    // 페이지 최초 로드
    $(document).ready(function() {
      loadList(true);
    });

    function likeRestaurant(rtNum) {
      alert(rtNum + '번 매장');
      // 추후 AJAX 찜 처리 연동
    }

    function openReviewModal(rtNum) {
      alert(rtNum + '번 매장');
      // 추후 리뷰 모달 연동
    }
  </script>
</main>

</body>
</html>

<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
  <meta charset="utf-8">
  <title>식당 리스트 상세</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .restaurant-card {
      border-radius: 16px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      overflow: hidden;
    }

    .restaurant-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .restaurant-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 16px 0 0 16px;
    }

    .restaurant-info {
      font-size: 0.95rem;
      color: #555;
    }

    .badge-title {
      background-color: #f8d57e;
      color: #333;
      font-weight: 600;
      padding: 0.35em 0.6em;
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    .btn-more, .btn-secondary {
      border-radius: 2rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
<main layout:fragment="content" class="container my-5">
  <div class="row g-4 restaurant-list">
    <div class="col-12" th:each="restaurant : ${list}">
      <div class="card restaurant-card shadow-sm h-100">
        <div class="row g-0">
          <!-- 이미지(차후 추가) -->
          <!-- <div class="col-md-4">
            <img th:src="@{/file/{path}(path=${restaurant.rt_thumb})}"
                 onerror="this.src='/img/noimg.jpg'"
                 class="restaurant-img" alt="식당 이미지">
          </div> -->

          <div class="col-md-8 d-flex align-items-center">
            <div class="card-body">
              <h5 class="card-title">
                <span class="badge-title" th:text="${restaurant.rt_name}">식당명</span>
              </h5>
              <p class="restaurant-info mb-2">
                <i class="bi bi-geo-alt"></i>
                <span th:text="${restaurant.rd_addr}">주소</span><br>
                <i class="bi bi-telephone"></i>
                <span th:text="${restaurant.rd_phone}">전화번호</span>
              </p>
              <p class="restaurant-info mb-1">
                <strong>가격대:</strong>
                <span th:text="'점심 ' + ${restaurant.rt_price_lunch} + ' / 저녁 ' + ${restaurant.rt_price_dinner}"></span>
              </p>
							<p class="restaurant-info">
								<strong>정기 휴일:</strong> <span th:text="${restaurant.rt_closed_days}">매주 월요일</span><br>
								<strong>홈페이지:</strong>
								<a th:href="${restaurant.rd_home != null} ? (${#strings.startsWith(restaurant.rd_home, 'http')} ? ${restaurant.rd_home} : 'http://' + ${restaurant.rd_home}) : '#'" th:text="${restaurant.rd_home != null ? restaurant.rd_home : '링크 없음'}" target="_blank">링크</a>
								<br>
								<strong>기타 정보:</strong> <span th:text="${restaurant.rd_info}">주차 가능 / 반려동물 동반 가능</span>
							</p>
							<div class="mt-2 d-flex justify-content-between">
								<button class="btn btn-outline-danger btn-sm"
                        th:attr="data-rt-num=${restaurant.rt_num}"
												th:onclick="'likeRestaurant(' + ${restaurant.rt_num} + ')'">
									<i class="bi bi-heart"></i> 찜하기
								</button>

								<button class="btn btn-outline-primary btn-sm"
												th:onclick="'openReviewModal(' + ${restaurant.rt_num} + ')'">
									<i class="bi bi-chat-dots"></i> 리뷰보기
								</button>
              	<p class="restaurant-info" th:text="${restaurant.rt_description}">설명</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center text-muted mt-4" th:if="${#lists.isEmpty(list)}">
    검색 결과가 없습니다.
  </div>

  <!-- 더보기 버튼 -->
  <div class="text-center mt-4">
    <button class="btn btn-outline-primary btn-more px-5" th:if="${pm.next}">더보기</button>
    <button th:unless="${pm.next}" class="btn btn-secondary px-5" disabled>마지막 페이지</button>
  </div>

  <!--유저넘버-->
  <div id="us_num" th:data-us-num="${us_num}"></div>

  <script>

  const us_num = document.getElementById('us_num') ? parseInt(document.getElementById('us_num').dataset.usNum) : null;

  // 찜 토글 함수
  function likeRestaurant(rt_num) {
    $.ajax({
      url: '/user/follow',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ uf_foreign : rt_num, uf_us_num : us_num, uf_type : "RESTAURANT" }),
      success: res => {
        const icon = $(`.like-btn[data-rt-num='${rt_num}'] i`);
        if (res.liked) {
          icon.removeClass('bi-heart').addClass('bi-heart-fill text-danger');
        } if (res.liked == false) {
          icon.removeClass('bi-heart-fill text-danger').addClass('bi-heart');
        } else{
          console.error('찜 상태 업데이트 실패:', res.error);
        }
      },
      error: err => console.error('찜 실패:', err)
    });
  }

  // 찜 여부 로딩 (페이지 로딩 시 실행)
  function loadUserLikes() {
    if (!us_num) return;

    $.ajax({
      url: `/user/follow/list?us_num=${us_num}`,
      type: 'GET',
      success: function(likedList) {
        likedList.forEach(rt_num => {
          const icon = $(`.like-btn[data-rt-num='${rt_num}'] i`);
          icon.removeClass('bi-heart').addClass('bi-heart-fill text-danger');
        });
      },
      error: function() {
        console.error("찜 리스트 불러오기 실패");
      }
    });
  }

  $(document).ready(function() {
    loadUserLikes();
  });
  </script>


</main>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</body>
</html>
